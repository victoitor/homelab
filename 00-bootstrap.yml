---

- name: Bootstrapping tasks
  hosts: homelab
  become: true

  pre_tasks:
  - name: Update apt cache
    apt: update_cache=yes cache_valid_time=3600

  tasks:
  - name: Configure timezone
    timezone: name=America/Fortaleza

  - name: Configure hostname
    hostname: 
      name: "{{ inventory_hostname }}"

  - name: "Sync authorized keys for user {{ ansible_user }} with github"
    authorized_key: user="{{ ansible_user }}" key="https://github.com/{{ ansible_user }}.keys"

  - name: Harden ssh server
    copy:
      src: ssh/default-ssh.conf
      dest: /etc/ssh/sshd_config.d/default-profile.conf
      owner: root
      group: root
      mode: 0644
    notify: sshd restart

  - name: "{{ ansible_user }} is sudoer with NOPASS: ALL"
    template:
      src: sudoers.j2
      dest: "/etc/sudoers.d/{{ ansible_user }}"
      owner: root
      group: root
      mode: 0440

  - name: bridge-utils and unattended-upgrades are installed
    apt:
      name: 
      - bridge-utils
      - unattended-upgrades

  - name: Configure unattended-upgrades
    copy:
      src: unattended-upgrades/20auto-upgrades
      dest: /etc/apt/apt.conf.d/20auto-upgrades
      owner: root
      group: root
      mode: 0644

  - name: Configure bridge br0
    copy: 
      src: networking/br0
      dest: /etc/network/interfaces.d/br0
      owner: root
      group: root
      mode: 0644
    notify: Reboot

  - name: Configure interfaces
    copy:
      src: networking/interfaces
      dest: /etc/network/interfaces
      backup: true
      owner: root
      group: root
      mode: 0644
    notify: Reboot

  - name: Configure GRUB_TIMEOUT
    lineinfile:
      path: /etc/default/grub
      regexp: '^GRUB_TIMEOUT='
      line: GRUB_TIMEOUT=0
    notify: Run update-grub

  - name: snapd installed
    apt: name=snapd

  - name: sudoers secure_path includes /snap/bin
    copy:
      src: lxd/secure-path
      dest: /etc/sudoers.d/secure-path
      owner: root
      group: root
      mode: 0440

  - name: Set snap refresh timer
    command: "snap set system refresh.timer=1:00-4:00"
    changed_when: false

  - name: core snap installed
    snap: name=core
    notify: Reboot

  handlers:
  - name: sshd restart
    service:
      name: sshd
      state: restarted

  - name: Run update-grub
    command: update-grub

  - name: Reboot
    command: reboot
    async: 1
    poll: 0

