---

- hosts: cluster
  become: true

  tasks:
    - name: Set timezone
      timezone: name=America/Fortaleza

    - name: Set hostname
      command: "hostnamectl set-hostname {{ inventory_hostname }}"
      when: ansible_nodename != inventory_hostname
    
    - name: Set snap refresh time
      command: "snap set system refresh.timer=1:00-4:00"
      changed_when: false

    - name: Install lxd/microcloud stack
      snap:
        name:
          - lxd
          - microovn
          - microcloud
          - microceph

    - name: Update network configuration
      template: 
        src: netplan-config.j2
        dest: /etc/netplan/00-snapd-config.yaml
        owner: root
        group: adm
        mode: 0600
      notify: Apply netplan

  handlers:
    - name: Apply netplan
      command: "netplan {{ item }}"
      with_items:
        - generate
        - apply
      async: 20
      poll: 0